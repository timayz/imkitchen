{% extends "_user.html" %}
{% block title %}{{ "Import Recipes - imkitchen"|t }}{% endblock %}
{% block content %}
<!-- Main Content -->

<div class="container mx-auto px-4 py-8 max-w-4xl">
  <!-- Header -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold mb-2">{{ "Import Recipes"|t }}</h1>
    <p class="text-gray-600">{{ "Bulk import recipes from JSON files"|t }}</p>
  </div>

  <!-- Upload Area -->
  <div class="bg-white rounded-lg shadow-lg p-8 mb-6">
    <div id="recipes-drop"
      class="border-4 border-dashed border-gray-300 rounded-lg p-12 text-center hover:border-green-500 transition cursor-pointer">
      <label for="recipes">
        <div class="text-6xl mb-4">ðŸ“¥</div>
        <h3 class="text-xl font-bold mb-2">{{ "Drag & Drop JSON Files"|t }}</h3>
        <p class="text-gray-600 mb-4">{{ "or click to browse"|t }}</p>
        <p class="text-sm text-gray-500 mt-4">{{ "Max 1MB â€¢ Up to 20 files â€¢ JSON format only"|t }}</p>
        <input type="file" id="recipes" class="hidden" multiple accept="application/json" />
      </label>
    </div>
  </div>

  <div id="recipes-area" ts-trigger="importRecipes" ts-req="/recipes/import" ts-req-method="post" ts-swap="inner"></div>

  <!-- Schema Documentation -->
  <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
    <h2 class="font-bold text-xl mb-4">{{ "JSON Schema Documentation"|t }}</h2>
    <p class="text-gray-600 mb-4">
      {{ "Download our"|t }} <a href="#" class="text-green-600 hover:text-green-700 font-semibold">{{ "official JSON schema (v1.0)"|t }}</a>
      {{ "for third-party tools"|t }}
    </p>

    <div class="bg-gray-50 rounded p-4 mb-4 overflow-x-auto">
      <pre class="text-sm">
        <code>
{
  "name": "Thai Red Curry", (min 3,max 50 length)
  "description": "Spicy coconut curry", (min 3, max 2000 length)
  "recipe_type": "Appetizer|MainCourse|Dessert|Accompaniment",
  "cuisine_type": "Thai|American|Caribbean|Chinese|Italian|French|Indian|Japanese|Mediterranean|Mexican",
  "prep_time": 15, ({{ "minutes > 0"|t }})
  "cook_time": 30, ({{ "minutes > 0"|t }})
  "ingredients": [
    { "quantity": 500, "unit": "G", "name": "Chicken breast" }, (quantity as u16, unit as "G"|"ML"|null)
    { "quantity": 1, "unit": null, "name": "Lemon" }
  ],
  "instructions": [
    { "description": "Heat oil in wok", "time_next": 12 ({{ "time to wait before next instruction, minutes >= 0"|t }}) }
  ],
  "advance_prep": "Marinate chicken 2 hours before" ({{ "optional"|t }})
}
        </code>
      </pre>
    </div>
</div>

<script>
  (() => {
    const area = document.getElementById("recipes-area");

    function updateAreaData(recipes){
      area.setAttribute("ts-json", JSON.stringify(recipes));
      area.dispatchEvent(new Event("importRecipes"));
    } 

    function importRecipes(files) {
      let reader = new FileReader();
      let recipes = [];

      function read(index) {
        if (index >= files.length) {
          updateAreaData(recipes);
          return;
        }

        reader.onload = (e) => {
          try {
            recipes.push(JSON.parse(e.target.result));
          } catch (error){
            console.error(error);
          }

          read(index + 1);
        };

        reader.readAsText(files[index]);
      }
      
      read(0);
    }

    const drop = document.getElementById("recipes-drop");
    drop.addEventListener("dragover", (e) => {
      e.preventDefault();
    }, false);

    drop.addEventListener("drop", (e) => {
      e.preventDefault();
      importRecipes(e.dataTransfer.files);
    });

    const input = document.getElementById("recipes");
    input.addEventListener("change", (e) => {
      importRecipes(e.target.files);
    });
  })();
</script>
{% endblock %}
