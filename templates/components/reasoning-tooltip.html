<!-- Story 3.8: Assignment Reasoning Tooltip Component -->
<!-- Usage: This component expects to be included in context where breakfast/lunch/dinner objects are available -->
{% match self.assignment_reasoning %}
{% when Some with (reasoning) %}
<div class="relative inline-block ml-2 reasoning-tooltip-container">
    <!-- Info Icon (clickable for mobile, hoverable for desktop) -->
    <button
        type="button"
        class="info-icon text-gray-400 hover:text-primary-500 transition-colors cursor-help"
        aria-label="Why this meal was assigned"
        data-reasoning="{{ reasoning }}">
        <!-- Heroicon: information-circle -->
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
        </svg>
    </button>

    <!-- Tooltip Content (hidden by default, shown on hover/click) -->
    <div
        class="reasoning-tooltip absolute z-50 hidden bg-gray-900 text-white text-xs rounded-lg py-2 px-3 max-w-xs shadow-lg"
        style="bottom: 125%; left: 50%; transform: translateX(-50%); min-width: 200px; max-width: 280px;"
        role="tooltip">
        <div class="text-center">{{ reasoning }}</div>
        <!-- Arrow pointing down -->
        <div class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0"
             style="border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 6px solid #111827;">
        </div>
    </div>
</div>

<!-- CSS for tooltip behavior (desktop hover, mobile tap) -->
<style>
/* Desktop: Hover behavior */
@media (hover: hover) and (pointer: fine) {
    .reasoning-tooltip-container:hover .reasoning-tooltip {
        display: block;
    }
}

/* Mobile: Click/tap behavior handled by JavaScript -->
.reasoning-tooltip.show-mobile {
    display: block !important;
}

/* Mobile overlay background */
#tooltip-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 40;
}

#tooltip-overlay.active {
    display: block;
}
</style>

<!-- JavaScript for mobile tap behavior (CSP-compliant: no inline handlers) -->
<script>
// Mobile tooltip handler
document.addEventListener('DOMContentLoaded', function() {
    // Only activate on touch devices
    if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
        const infoIcons = document.querySelectorAll('.info-icon');

        infoIcons.forEach(function(icon) {
            icon.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();

                const tooltip = icon.nextElementSibling;

                // Close other tooltips
                document.querySelectorAll('.reasoning-tooltip.show-mobile').forEach(function(t) {
                    if (t !== tooltip) {
                        t.classList.remove('show-mobile');
                    }
                });

                // Toggle this tooltip
                const wasOpen = tooltip.classList.contains('show-mobile');
                tooltip.classList.toggle('show-mobile');

                // Handle overlay
                let overlay = document.getElementById('tooltip-overlay');
                if (!overlay) {
                    overlay = document.createElement('div');
                    overlay.id = 'tooltip-overlay';
                    document.body.appendChild(overlay);

                    // Close tooltip on overlay click
                    overlay.addEventListener('click', function() {
                        document.querySelectorAll('.reasoning-tooltip.show-mobile').forEach(function(t) {
                            t.classList.remove('show-mobile');
                        });
                        overlay.classList.remove('active');
                    });
                }

                if (!wasOpen) {
                    overlay.classList.add('active');
                } else {
                    overlay.classList.remove('active');
                }
            });
        });
    }
});
</script>
{% when None %}
<!-- No reasoning available -->
{% endmatch %}
