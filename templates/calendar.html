{% extends "_user.html" %}
{% block title %}{{ "Meal Calendar"|t }} - imkitchen{% endblock %}
{% block content %}
    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        {% if generation_needed %}
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
          <div class="flex items-start gap-3">
            <div class="shrink-0 mt-0.5">
              <div class="animate-spin rounded-full h-5 w-5 border-2 border-yellow-200 border-t-yellow-600"></div>
            </div>
            <div class="flex-1">
              <div class="font-semibold text-yellow-800">{{ "Creating Your Weekly Meal Plan..."|t }}</div>
              <div class="text-sm text-yellow-700 mt-1">{{ "We're selecting the perfect recipes for you."|t }}</div>
            </div>
          </div>
        </div>
        <div class="hidden"><div ts-trigger="load" ts-req="/calendar/regenerate" ts-req-method="post"></div></div>
        <!-- Empty State -->
        {% else if is_empty_state %}
        <div class="max-w-2xl mx-auto">
            <div class="bg-white rounded-lg shadow-lg p-12 text-center">
                <div class="text-6xl mb-6">üìÖ</div>
                <h2 class="text-2xl font-bold mb-4">{{ "No Meal Plan Yet"|t }}</h2>
                <p class="text-gray-600 mb-8">
                    {{ "Your calendar is empty. Start by adding recipes to your collection, then we'll help you plan your meals for the upcoming weeks."|t }}
                </p>

                <!-- Steps to Get Started -->
                <div class="space-y-4 mb-8 text-left">
                    <div class="flex items-start gap-4 p-4 bg-green-50 rounded-lg">
                        <div class="shrink-0 w-8 h-8 bg-green-600 text-white rounded-full flex items-center justify-center font-bold">1</div>
                        <div>
                            <h3 class="font-semibold mb-1">{{ "Add Recipes"|t }}</h3>
                            <p class="text-sm text-gray-600">{{ "Build your recipe collection by creating or importing recipes"|t }}</p>
                        </div>
                    </div>

                    <div class="flex items-start gap-4 p-4 bg-blue-50 rounded-lg">
                        <div class="shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold">2</div>
                        <div>
                            <h3 class="font-semibold mb-1">{{ "Generate Meal Plans"|t }}</h3>
                            <p class="text-sm text-gray-600">{{ "We'll automatically create weekly meal plans based on your recipes"|t }}</p>
                        </div>
                    </div>

                    <div class="flex items-start gap-4 p-4 bg-orange-50 rounded-lg">
                        <div class="shrink-0 w-8 h-8 bg-orange-600 text-white rounded-full flex items-center justify-center font-bold">3</div>
                        <div>
                            <h3 class="font-semibold mb-1">{{ "Get Shopping Lists"|t }}</h3>
                            <p class="text-sm text-gray-600">{{ "Access organized shopping lists for each week's meals"|t }}</p>
                        </div>
                    </div>
                </div>

                <!-- Call to Action -->
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <a href="/recipes" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition">
                        ‚ûï {{ "Add Recipes"|t }}
                    </a>
                    <a href="/" class="px-6 py-3 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition">
                        üè† {{ "Back to Dashboard"|t }}
                    </a>
                </div>
            </div>
        </div>
        {% else %}

        <!-- Header -->
        <div class="mb-8">
          <h1 class="text-3xl font-bold mb-2">{{ "Meal Calendar"|t }}</h1>
          {% if let Some(current) = current %}
          <p class="text-gray-600">{{ current.start|month_year(current.end) }}</p>
          {% endif %}
        </div>

        <!-- Week Navigation -->
        <div class="bg-white rounded-lg shadow-lg p-4 md:p-6 mb-6">
            <!-- Mobile: Stack vertically -->
            <div class="flex flex-col gap-3 md:hidden">
                <div class="flex items-center justify-between gap-2">
                    <a href="/calendar/week-{{ index }}/shopping"
                      class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm">
                        üõí
                    </a>
                    <a href="/calendar/week-{{ index }}" class="px-3 py-2 bg-green-600 text-white rounded-lg font-semibold text-sm flex-1">
                      {{ "Week"|t }} {{ index }}
                    </a>
                    <button id="regenerate-btn-sm" ts-trigger="click" ts-req="/calendar/regenerate" ts-target="body" ts-swap="append"
                      class="px-3 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 text-sm">
                        üîÑ
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <div class="flex gap-2 min-w-max">
                      {% for week in weeks %}
                        {% if loop.index != index as usize %}
                          <a href="/calendar/week-{{ loop.index }}" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm whitespace-nowrap">
                            {{ "Week"|t }} {{ loop.index }}
                          </a>
                        {% endif %}
                      {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Desktop: Original layout -->
            <div class="hidden md:flex items-center justify-between">
                <a href="/calendar/week-{{ index }}/shopping"
                  class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                    üõí {{ "Shopping List"|t }}
                </a>
                <div class="flex gap-2">
                    {% for week in weeks %}
                    <a href="/calendar/week-{{ loop.index }}"
                      class="px-4 py-2 rounded-lg {% if loop.index == index as usize %}text-white bg-green-600 font-semibold{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %}">
                      {{ "Week"|t }} {{ loop.index }}
                    </a>
                    {% endfor %}
                </div>

                <button id="regenerate-btn" ts-trigger="click" ts-req="/calendar/regenerate" ts-target="body" ts-swap="append"
                  class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">
                    üîÑ {{ "Regenerate"|t }}
                </button>
            </div>
        </div>

        {% if !user.is_premium() %}
        <!-- Premium Upgrade Banner -->
        <div class="bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 rounded-lg p-4 md:p-6 mb-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-2xl">‚ú®</span>
                        <h3 class="font-bold text-lg text-amber-900">{{ "Unlock the Full Experience"|t }}</h3>
                    </div>
                    <p class="text-amber-800 text-sm mb-3">{{ "You're on the free plan. Upgrade to Premium to get:"|t }}</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
                        <div class="flex items-center gap-2 text-amber-700">
                            <span class="text-green-600">‚úì</span>
                            <span>{{ "Unlimited recipes in plan"|t }}</span>
                        </div>
                        <div class="flex items-center gap-2 text-amber-700">
                            <span class="text-green-600">‚úì</span>
                            <span>{{ "Appetizers, desserts & sides"|t }}</span>
                        </div>
                        <div class="flex items-center gap-2 text-amber-700">
                            <span class="text-green-600">‚úì</span>
                            <span>{{ "Meal preferences applied"|t }}</span>
                        </div>
                        <div class="flex items-center gap-2 text-amber-700">
                            <span class="text-green-600">‚úì</span>
                            <span>{{ "Batch recipe import"|t }}</span>
                        </div>
                    </div>
                </div>
                <div class="shrink-0">
                    <a href="/upgrade" class="inline-block px-6 py-3 bg-gradient-to-r from-amber-500 to-orange-500 text-white font-semibold rounded-lg hover:from-amber-600 hover:to-orange-600 transition shadow-md">
                        {{ "Upgrade to Premium"|t }}
                    </a>
                </div>
            </div>
        </div>
        {% endif %}

        {% if let Some(current) = current %}
        <!-- Calendar Grid - Week 1 -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-7 gap-4 mb-8">
          {% for slot in current.slots.0 %}
            <!-- Monday 11/4 -->
            <div class="bg-white rounded-lg shadow p-4 min-h-[300px] md:min-h-[250px]{% if slot.day == weekday %} border-2 border-green-500{% endif %}">
                <div class="mb-3">
                    <div class="flex items-center justify-between mb-1">
                      <span class="font-bold text-lg lg:text-base">{{ slot.day|date }}</span>
                        <!-- <span class="font-bold text-lg lg:text-base">Monday, Nov 4</span> -->
                        {% if slot.day == weekday %}
                        <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">{{ "Today"|t }}</span>
                        {% endif %}
                    </div>
                    <div class="text-xs text-gray-500 lg:hidden">{{ "Week"|t }} {{ index }}</div>
                </div>
                <div class="space-y-3">
                    {% if let Some(appetizer) = slot.appetizer %}
                    <div class="p-2 bg-blue-50 rounded text-sm">
                        <div class="text-xs text-blue-600 font-semibold">{{ "APPETIZER"|t }}</div>
                        <div class="font-semibold">ü•ó {{ appetizer.name }}</div>
                    </div>
                    {% endif %}
                    <div class="p-2 bg-orange-50 rounded text-sm">
                        <div class="text-xs text-orange-600 font-semibold">{{ "MAIN"|t }}</div>
                        <div class="font-semibold">üçõ {{ slot.main_course.name }}</div>
                        {% if let Some(accompaniment) = slot.accompaniment %}
                        <div class="text-xs text-gray-600">+ üçö {{ accompaniment.name }}</div>
                        {% endif %}
                    </div>
                    {% if let Some(dessert) = slot.dessert %}
                    <div class="p-2 bg-pink-50 rounded text-sm">
                        <div class="text-xs text-pink-600 font-semibold">{{ "DESSERT"|t }}</div>
                        <div class="font-semibold">üç∞ {{ dessert.name }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
          {% endfor %}
        </div>
        {% endif %}
        {% endif %}
    </div>
{% endblock %}
