openapi: 3.0.0
info:
  title: imkitchen Meal Planning API
  version: 1.0.0
  description: |
    HTTP API for multi-week meal planning, week navigation, regeneration, and user preferences management.

    This API enables intelligent meal planning automation with:
    - Multi-week meal plan generation (up to 5 weeks)
    - Week-by-week navigation and viewing
    - Single week and bulk week regeneration
    - User meal planning preferences customization

    All routes require authentication via JWT cookie.
  contact:
    name: imkitchen Support
    email: support@imkitchen.app
  license:
    name: MIT

servers:
  - url: http://localhost:3000
    description: Local development
  - url: https://api.imkitchen.app
    description: Production

security:
  - cookieAuth: []

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: session
      description: JWT cookie containing user authentication token

  schemas:
    MultiWeekResponse:
      type: object
      required:
        - generation_batch_id
        - max_weeks_possible
        - current_week_index
        - first_week
        - navigation
      properties:
        generation_batch_id:
          type: string
          format: uuid
          description: Unique identifier for this meal plan generation batch
        max_weeks_possible:
          type: integer
          description: Maximum number of weeks that could be generated (typically 5)
        current_week_index:
          type: integer
          description: Index of the current week (0-based)
        first_week:
          $ref: '#/components/schemas/WeekDetail'
        navigation:
          $ref: '#/components/schemas/Navigation'

    WeekDetail:
      type: object
      required:
        - id
        - start_date
        - end_date
        - status
        - is_locked
        - meal_assignments
      properties:
        id:
          type: string
          description: Unique week identifier
        start_date:
          type: string
          format: date
          description: Week start date (Monday)
        end_date:
          type: string
          format: date
          description: Week end date (Sunday)
        status:
          type: string
          enum: [current, future, past]
          description: Week status relative to today
        is_locked:
          type: boolean
          description: Whether the week is locked (current week cannot be regenerated)
        meal_assignments:
          type: array
          items:
            $ref: '#/components/schemas/MealAssignment'
          description: 21 meal assignments (7 days Ã— 3 meals)
        shopping_list_id:
          type: string
          description: ID of the associated shopping list

    MealAssignment:
      type: object
      required:
        - id
        - date
        - course_type
        - recipe
      properties:
        id:
          type: string
          description: Unique meal assignment identifier
        date:
          type: string
          format: date
          description: Date of this meal
        course_type:
          type: string
          enum: [appetizer, main_course, dessert]
          description: Type of course
        recipe:
          $ref: '#/components/schemas/RecipeSummary'
        accompaniment:
          $ref: '#/components/schemas/AccompanimentSummary'
          nullable: true
        prep_required:
          type: boolean
          description: Whether advance preparation is required
        algorithm_reasoning:
          type: string
          description: Human-readable explanation of why this recipe was assigned to this day

    RecipeSummary:
      type: object
      required:
        - id
        - title
        - prep_time_min
        - cook_time_min
        - complexity
      properties:
        id:
          type: string
        title:
          type: string
        prep_time_min:
          type: integer
        cook_time_min:
          type: integer
        complexity:
          type: string
          enum: [simple, moderate, complex]

    AccompanimentSummary:
      type: object
      required:
        - id
        - title
        - category
      properties:
        id:
          type: string
        title:
          type: string
        category:
          type: string

    Navigation:
      type: object
      properties:
        previous_week_id:
          type: string
          nullable: true
        next_week_id:
          type: string
          nullable: true
        week_links:
          type: array
          items:
            $ref: '#/components/schemas/WeekLink'

    WeekLink:
      type: object
      required:
        - week_id
        - start_date
        - is_current
      properties:
        week_id:
          type: string
        start_date:
          type: string
          format: date
        is_current:
          type: boolean

    MealPlanningPreferences:
      type: object
      required:
        - max_prep_time_weeknight
        - max_prep_time_weekend
        - avoid_consecutive_complex
        - cuisine_variety_weight
      properties:
        max_prep_time_weeknight:
          type: integer
          minimum: 1
          description: Maximum prep time allowed for weeknight meals (minutes)
        max_prep_time_weekend:
          type: integer
          minimum: 1
          description: Maximum prep time allowed for weekend meals (minutes)
        avoid_consecutive_complex:
          type: boolean
          description: Whether to avoid scheduling complex recipes on consecutive days
        cuisine_variety_weight:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
          description: Weight for cuisine variety (0.0 = ignore, 1.0 = maximize)

    Error:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Error code identifier
        message:
          type: string
          description: Human-readable error message
        details:
          type: object
          description: Additional error-specific details
        action:
          type: object
          description: Suggested action to resolve the error
          properties:
            label:
              type: string
            url:
              type: string

paths:
  /plan/generate-multi-week:
    post:
      summary: Generate multi-week meal plan
      description: |
        Generates an automated multi-week meal plan (up to 5 weeks) based on user's favorite recipes
        and meal planning preferences. Returns the first week with navigation links to other weeks.

        **Requirements:**
        - User must have at least 7 favorite recipes in each category (appetizer, main_course, dessert)
        - Authentication via JWT cookie required

        **Rate Limit:** 5 requests per hour per user
      operationId: generateMultiWeekMealPlan
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Meal plan generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MultiWeekResponse'
              example:
                generation_batch_id: "550e8400-e29b-41d4-a716-446655440000"
                max_weeks_possible: 5
                current_week_index: 0
                first_week:
                  id: "week_1"
                  start_date: "2025-10-28"
                  end_date: "2025-11-03"
                  status: "future"
                  is_locked: false
                  meal_assignments: []
                  shopping_list_id: "shopping_1"
                navigation:
                  next_week_id: "week_2"
                  week_links: []
        '400':
          description: Insufficient recipes or invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "InsufficientRecipes"
                message: "You need at least 7 favorite recipes in each category to generate a meal plan."
                details:
                  appetizers: 5
                  main_courses: 3
                  desserts: 7
                action:
                  label: "Add More Recipes"
                  url: "/recipes/new"
        '401':
          description: Unauthorized - JWT cookie missing or invalid
        '500':
          description: Algorithm timeout or internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "AlgorithmTimeout"
                message: "Meal plan generation took too long. Please try again."

  /plan/week/{week_id}:
    get:
      summary: Get week detail
      description: |
        Retrieves detailed information for a specific week including meal assignments and shopping list.

        **Authorization:** Week must belong to the authenticated user.
      operationId: getWeekDetail
      security:
        - cookieAuth: []
      parameters:
        - name: week_id
          in: path
          required: true
          description: Unique identifier of the week
          schema:
            type: string
      responses:
        '200':
          description: Week detail retrieved successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - week
                  - navigation
                properties:
                  week:
                    $ref: '#/components/schemas/WeekDetail'
                  shopping_list:
                    type: object
                    description: Shopping list for the week (optional)
                  navigation:
                    $ref: '#/components/schemas/Navigation'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - Week belongs to a different user
        '404':
          description: Week not found

  /plan/week/{week_id}/regenerate:
    post:
      summary: Regenerate single week
      description: |
        Regenerates meal assignments for a specific future week. Current and past weeks cannot be regenerated.

        **Restrictions:**
        - Week must have status "future"
        - Week must not be locked (is_locked == false)
        - Week must belong to authenticated user

        **Rate Limit:** 10 requests per hour per user
      operationId: regenerateWeek
      security:
        - cookieAuth: []
      parameters:
        - name: week_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Week regenerated successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - week
                  - message
                properties:
                  week:
                    $ref: '#/components/schemas/WeekDetail'
                  message:
                    type: string
        '400':
          description: Week already started or invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "WeekAlreadyStarted"
                message: "Cannot regenerate a week that has already started."
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - Week locked or belongs to different user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "WeekLocked"
                message: "Cannot regenerate current week. It is locked to prevent disrupting in-progress meals."
        '404':
          description: Week not found

  /plan/regenerate-all-future:
    post:
      summary: Regenerate all future weeks
      description: |
        Regenerates all future weeks while preserving the current week. Requires explicit confirmation
        to prevent accidental data loss.

        **Important:** This action cannot be undone. All future meal assignments will be replaced.

        **Rate Limit:** 10 requests per hour per user
      operationId: regenerateAllFutureWeeks
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - confirmation
              properties:
                confirmation:
                  type: boolean
                  description: Must be true to confirm regeneration
            example:
              confirmation: true
      responses:
        '200':
          description: All future weeks regenerated successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - regenerated_weeks
                  - preserved_current_week_id
                  - first_future_week
                  - message
                properties:
                  regenerated_weeks:
                    type: integer
                    description: Number of weeks regenerated
                  preserved_current_week_id:
                    type: string
                    description: ID of the current week that was preserved
                  first_future_week:
                    $ref: '#/components/schemas/WeekDetail'
                  message:
                    type: string
              example:
                regenerated_weeks: 4
                preserved_current_week_id: "week_1"
                first_future_week: {}
                message: "All 4 future weeks regenerated successfully. Current week preserved."
        '400':
          description: Confirmation required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "ConfirmationRequired"
                message: 'This action requires confirmation. Include { "confirmation": true } in request body.'
        '401':
          description: Unauthorized

  /profile/meal-planning-preferences:
    put:
      summary: Update meal planning preferences
      description: |
        Updates user's meal planning preferences which will be applied to future meal plan generations.

        **Validation:**
        - max_prep_time_weeknight must be > 0
        - max_prep_time_weekend must be > 0
        - cuisine_variety_weight must be between 0.0 and 1.0
      operationId: updateMealPlanningPreferences
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MealPlanningPreferences'
            example:
              max_prep_time_weeknight: 30
              max_prep_time_weekend: 90
              avoid_consecutive_complex: true
              cuisine_variety_weight: 0.7
      responses:
        '200':
          description: Preferences updated successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - preferences
                  - message
                properties:
                  preferences:
                    $ref: '#/components/schemas/MealPlanningPreferences'
                  message:
                    type: string
              example:
                preferences:
                  max_prep_time_weeknight: 30
                  max_prep_time_weekend: 90
                  avoid_consecutive_complex: true
                  cuisine_variety_weight: 0.7
                message: "Meal planning preferences updated. Changes will apply to your next meal plan generation."
        '400':
          description: Validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "ValidationFailed"
                message: "Invalid preferences provided."
                details:
                  max_prep_time_weeknight: "Must be greater than 0"
                  cuisine_variety_weight: "Must be between 0.0 and 1.0"
        '401':
          description: Unauthorized

tags:
  - name: Meal Planning
    description: Multi-week meal plan generation and management
  - name: Preferences
    description: User meal planning preferences
