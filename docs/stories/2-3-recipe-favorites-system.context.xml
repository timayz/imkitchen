<story-context id="bmad/bmm/workflows/4-implementation/story-context/2-3" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2.3</storyId>
    <title>Recipe Favorites System</title>
    <status>drafted</status>
    <generatedAt>2025-11-03</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/2-3-recipe-favorites-system.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user</asA>
    <iWant>to favorite recipes (my own and community recipes)</iWant>
    <soThat>I can designate which recipes should be included in meal plan generation</soThat>
    <tasks>
      - Define Recipe favorite events (RecipeFavorited, RecipeUnfavorited)
      - Implement Recipe aggregate handlers for favorites (favorite_count tracking)
      - Implement favorite/unfavorite commands with tier limits (free: 10 max, premium: unlimited)
      - Create recipe_favorites migration with composite PK and ON DELETE CASCADE
      - Implement query handlers for favorite events
      - Create favorite toggle route (POST /recipes/{id}/favorite) with tier checks
      - Update recipe cards with favorite button (filled/outline heart icon)
      - Create upgrade modal template (10 favorites limit, no unfavoriting option)
      - Add favorited recipes to user profile (list with count)
      - Verify cascade deletion handling (ON DELETE CASCADE FK)
      - Write integration tests for favorite limits, premium bypass, cascade deletion
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-2.3.1">RecipeFavorited and RecipeUnfavorited events store user-recipe relationship</criterion>
    <criterion id="AC-2.3.2">Free tier users limited to maximum 10 favorited recipes</criterion>
    <criterion id="AC-2.3.3">Attempting to exceed 10 favorites shows upgrade modal (no unfavoriting option)</criterion>
    <criterion id="AC-2.3.4">Premium tier users have unlimited favorites</criterion>
    <criterion id="AC-2.3.5">Recipe cards show favorite button with toggle state</criterion>
    <criterion id="AC-2.3.6">User profile displays favorited recipes list</criterion>
    <criterion id="AC-2.3.7">When recipe owner deletes recipe, all favorites automatically removed (no notifications)</criterion>
    <criterion id="AC-2.3.8">Query projection tracks favorite_count per recipe for community sorting</criterion>
    <criterion id="AC-2.3.9">Tests verify favorite limits, premium bypass, and cascade deletion</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/tech-spec-epic-2.md</path>
        <title>Epic 2 Technical Specification</title>
        <section>APIs - Recipe Favorite Toggle</section>
        <snippet>POST /recipes/{id}/favorite. Commands: favorite_recipe, unfavorite_recipe. Access Control: Check favorite count before favoriting; free tier max 10. Return upgrade modal HTML if limit exceeded.</snippet>
      </doc>
      <doc>
        <path>docs/tech-spec-epic-2.md</path>
        <title>Epic 2 Technical Specification</title>
        <section>Workflows - Recipe Favorite Flow</section>
        <snippet>Query user's current favorite count. Access control check: access_control.can_add_favorite(user_id). Premium/bypass: unlimited. Free tier: count >= 10 return upgrade-modal.html. If allowed: emit RecipeFavorited event.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Decision Architecture</title>
        <section>ADR-004 - Centralized Access Control Service</section>
        <snippet>AccessControlService with can_add_favorite() method. Checks: is_premium_active OR premium_bypass OR global_premium_bypass. Service located at src/access_control.rs.</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>FR012-FR014</section>
        <snippet>Users favorite both own and community recipes. Free tier: 10 max. Exceed limit shows upgrade modal with no unfavoriting option. Premium: unlimited favorites. Strong conversion incentive.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>src/access_control.rs</path>
        <kind>service</kind>
        <symbol>AccessControlService::can_add_favorite</symbol>
        <lines>all</lines>
        <reason>Existing freemium access control service for favorite limit enforcement</reason>
      </artifact>
      <artifact>
        <path>crates/imkitchen-recipe/src/event.rs</path>
        <kind>event definitions</kind>
        <symbol>RecipeFavorited, RecipeUnfavorited</symbol>
        <lines>all</lines>
        <reason>Add favorite events with user_id and recipe_id</reason>
      </artifact>
    </code>

    <dependencies>
      <rust>
        <package name="evento" version="1.5">Events for favorites</package>
        <package name="axum" version="0.8">POST route</package>
        <package name="sqlx" version="0.8">Favorite count query</package>
      </rust>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint id="C-1">Free tier: 10 max favorites (is_premium_active OR premium_bypass OR global bypass)</constraint>
    <constraint id="C-2">Premium tier: unlimited favorites</constraint>
    <constraint id="C-3">Upgrade modal has NO unfavoriting option (strong conversion incentive)</constraint>
    <constraint id="C-4">ON DELETE CASCADE FK automatically removes favorites when recipe deleted</constraint>
    <constraint id="C-5">NO notifications sent when favorites cascade deleted</constraint>
    <constraint id="C-6">Query favorite count before favoriting (prevent race conditions)</constraint>
    <constraint id="C-7">Use access_control.rs service for consistent freemium enforcement</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>POST /recipes/{id}/favorite</name>
      <kind>REST endpoint</kind>
      <signature>
Route: POST /recipes/{id}/favorite
Input: recipe_id (path)
Output: HTML partial (button state OR upgrade modal)
Commands: favorite_recipe or unfavorite_recipe
Access Control: can_add_favorite(user_id)
      </signature>
      <path>src/routes/recipes/favorite.rs</path>
    </interface>

    <interface>
      <name>recipe_favorites table</name>
      <kind>Database projection</kind>
      <signature>
CREATE TABLE recipe_favorites (
    user_id TEXT NOT NULL,
    recipe_id TEXT NOT NULL,
    favorited_at INTEGER NOT NULL,
    PRIMARY KEY (user_id, recipe_id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (recipe_id) REFERENCES recipes(id) ON DELETE CASCADE
);
      </signature>
      <path>migrations/queries/20250101000003_recipe_favorites.sql</path>
    </interface>

    <interface>
      <name>RecipeFavorited Event</name>
      <kind>Domain Event</kind>
      <signature>
#[derive(Encode, Decode, Clone)]
pub struct RecipeFavorited {
    pub user_id: String,
    pub recipe_id: String,
}
      </signature>
      <path>crates/imkitchen-recipe/src/event.rs</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Integration tests in tests/recipes_test.rs. Test access control service integration. Use evento API and query functions for validation.</standards>
    <locations>
      <location>tests/recipes_test.rs</location>
    </locations>
    <ideas>
      <idea ac="AC-2.3.2">Integration test: free tier user favorites 10 recipes → attempt 11th → verify error/upgrade modal</idea>
      <idea ac="AC-2.3.4">Integration test: premium tier user favorites >10 recipes → verify allowed</idea>
      <idea ac="AC-2.3.7">Integration test: favorite recipe → delete recipe → verify cascade deletion from recipe_favorites</idea>
      <idea ac="AC-2.3.8">Integration test: favorite/unfavorite → verify favorite_count projection updates</idea>
    </ideas>
  </tests>
</story-context>
