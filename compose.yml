services:
  traefik:
    image: "traefik:v3.6"
    group_add:
      - "${DOCKER_GID:-999}"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`traefik.localhost`)"
      - "traefik.http.routers.api.tls=true"
      - "traefik.http.routers.api.entrypoints=https"
      - "traefik.http.routers.api.service=api@internal"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - ".docker/traefik/traefik.yaml:/etc/traefik/traefik.yml"
      - ".docker/traefik/dynamic.yaml:/etc/traefik/dynamic.yml"
      - ".docker/traefik/certs:/etc/traefik/certs"
    extra_hosts:
      - host.docker.internal:host-gateway

  # imkitchen-migrate - Database migration init container
  # Runs migrations before the main app starts
  imkitchen-migrate:
    # image: timayz/imkitchen:latest
    build: .
    pull_policy: always
    container_name: imkitchen-migrate
    command: ["migrate", "--config", "/etc/imkitchen/config.toml"]
    volumes:
      - ./config/default.toml:/etc/imkitchen/config.toml:ro
      - imkitchen-data:/var/lib/imkitchen
    networks:
      - imkitchen-network
    restart: "no"
    profiles:
      - standalone

  # imkitchen - Main application
  # Access web UI at: http://localhost:3000
  imkitchen:
    # image: timayz/imkitchen:latest
    build: .
    pull_policy: always
    container_name: imkitchen-app
    command: ["serve", "--config", "/etc/imkitchen/config.toml"]
    volumes:
      - ./config/default.toml:/etc/imkitchen/config.toml:ro
      - imkitchen-data:/var/lib/imkitchen
    networks:
      - imkitchen-network
    restart: unless-stopped
    profiles:
      - standalone
    depends_on:
      imkitchen-migrate:
        condition: service_completed_successfully
      maildev:
        condition: service_started
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.imkitchen.rule=Host(`docker.imkitchen.localhost`)"
      - "traefik.http.routers.imkitchen.tls=true"
      - "traefik.http.routers.imkitchen.entrypoints=https"
      - "traefik.http.routers.imkitchen.service=imkitchen"
      - "traefik.http.services.imkitchen.loadbalancer.server.port=3000"

  # MailDev - SMTP testing server with web UI
  # Access web UI at: http://localhost:1080
  # SMTP server runs on: localhost:1025
  maildev:
    image: maildev/maildev:latest
    container_name: imkitchen-maildev
    ports:
      - "1080:1080" # Web UI
      - "1025:1025" # SMTP Server
    environment:
      - MAILDEV_WEB_PORT=1080
      - MAILDEV_SMTP_PORT=1025
    networks:
      - imkitchen-network
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://localhost:1080",
        ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

networks:
  imkitchen-network:
    driver: bridge

volumes:
  imkitchen-data:
    driver: local
