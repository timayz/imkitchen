function isIOSSafari(){const e=navigator.userAgent,n=/iPad|iPhone|iPod/.test(e)&&!window.MSStream,t=/^((?!chrome|android).)*safari/i.test(e);return n&&t}function isBackgroundSyncSupported(){return"serviceWorker"in navigator&&"SyncManager"in window}function initializeIOSFallback(){isIOSSafari()&&!isBackgroundSyncSupported()&&(console.log("iOS Safari detected - Background Sync API not supported, showing fallback"),showIOSWarning(),showManualSyncButton())}function showIOSWarning(){const e="ios-sync-warning";if("true"===localStorage.getItem(e+"-dismissed"))return;if(document.getElementById(e))return;const n=document.createElement("div");n.id=e,n.className="fixed top-4 right-4 bg-yellow-50 border border-yellow-200 text-yellow-900 p-4 rounded-lg shadow-lg max-w-sm z-50",n.innerHTML='\n    <div class="flex items-start">\n      <svg class="w-5 h-5 mr-2 text-yellow-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>\n      </svg>\n      <div class="flex-1">\n        <h3 class="font-medium text-sm">Background sync not available on iOS</h3>\n        <p class="text-xs mt-1">Stay online when submitting changes, or use the manual sync button if you go offline.</p>\n        <button onclick="dismissIOSWarning()" class="mt-2 text-xs font-medium text-yellow-700 underline">Dismiss</button>\n      </div>\n    </div>\n  ',document.body.appendChild(n),setTimeout(()=>{dismissIOSWarning()},15e3)}function dismissIOSWarning(){const e=document.getElementById("ios-sync-warning");e&&(e.remove(),localStorage.setItem("ios-sync-warning-dismissed","true"))}function showManualSyncButton(){const e="manual-sync-button";if(document.getElementById(e))return;const n=document.createElement("button");n.id=e,n.className="fixed bottom-20 right-4 bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-full shadow-lg z-40 transition-transform transform hover:scale-105",n.setAttribute("aria-label","Sync Now"),n.innerHTML='\n    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>\n    </svg>\n  ',n.onclick=triggerManualSync,document.body.appendChild(n),n.title="Sync offline changes now"}async function triggerManualSync(){console.log("Manual sync triggered");const e=document.getElementById("manual-sync-button");e&&(e.disabled=!0,e.innerHTML='\n      <svg class="w-6 h-6 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>\n      </svg>\n    ');try{"serviceWorker"in navigator&&navigator.serviceWorker.controller?(navigator.serviceWorker.controller.postMessage({type:"MANUAL_SYNC"}),showToast("Syncing changes...","info")):showToast("Service worker not available. Please reload the page.","error")}catch(e){console.error("Manual sync failed:",e),showToast("Sync failed. Please try again.","error")}finally{e&&(e.disabled=!1,e.innerHTML='\n        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>\n        </svg>\n      ')}}function showSyncProgress(e,n){const t="sync-progress-toast";let o=document.getElementById(t);o||(o=document.createElement("div"),o.id=t,o.className="fixed bottom-4 right-4 bg-blue-50 border border-blue-200 text-blue-900 p-4 rounded-lg shadow-lg max-w-sm z-50 transition-opacity",document.body.appendChild(o)),o.innerHTML=`\n    <div class="flex items-center">\n      <svg class="w-5 h-5 mr-2 text-blue-600 animate-spin" fill="none" viewBox="0 0 24 24">\n        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>\n        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>\n      </svg>\n      <div class="flex-1">\n        <p class="font-medium text-sm">Syncing changes... (${e} of ${n})</p>\n        <div class="w-full bg-blue-200 rounded-full h-1.5 mt-2">\n          <div class="bg-blue-600 h-1.5 rounded-full transition-all" style="width: ${e/n*100}%"></div>\n        </div>\n      </div>\n    </div>\n  `,o.style.opacity="1"}function hideSyncProgress(){const e=document.getElementById("sync-progress-toast");e&&(e.style.opacity="0",setTimeout(()=>{e.remove()},300))}function showToast(e,n="info",t=3e3){const o=`toast-${Date.now()}`,s=document.createElement("div");s.id=o;const r={success:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>',error:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>',info:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>',warning:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>'};s.className=`fixed bottom-4 right-4 ${{success:"bg-green-50 border-green-200 text-green-900",error:"bg-red-50 border-red-200 text-red-900",info:"bg-blue-50 border-blue-200 text-blue-900",warning:"bg-yellow-50 border-yellow-200 text-yellow-900"}[n]} border p-4 rounded-lg shadow-lg max-w-sm z-50 transition-opacity`,s.style.opacity="0",s.innerHTML=`\n    <div class="flex items-start">\n      <svg class="w-5 h-5 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n        ${r[n]}\n      </svg>\n      <div class="flex-1">\n        <p class="text-sm">${e}</p>\n      </div>\n      <button onclick="this.closest('.fixed').remove()" class="ml-2 text-gray-400 hover:text-gray-600">\n        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>\n        </svg>\n      </button>\n    </div>\n  `,document.body.appendChild(s),setTimeout(()=>{s.style.opacity="1"},10),t>0&&setTimeout(()=>{s.style.opacity="0",setTimeout(()=>{s.remove()},300)},t)}function initializeServiceWorkerMessageListener(){"serviceWorker"in navigator&&(navigator.serviceWorker.addEventListener("message",e=>{const{type:n,data:t}=e.data||{};switch(console.log("Message from service worker:",n,t),n){case"SYNC_PROGRESS":showSyncProgress(t.current,t.total);break;case"SYNC_COMPLETE":hideSyncProgress(),showToast("Your changes have been synced!","success",3e3);break;case"SYNC_ERROR":hideSyncProgress(),showToast(t.message||"Sync failed. Will retry automatically.","error",5e3);break;case"SYNC_CONFLICT":hideSyncProgress(),showToast(`Conflict detected for ${t.itemName}. Server version restored. Please review changes.`,"warning",8e3);break;default:console.log("Unknown message type from service worker:",n)}}),console.log("Service worker message listener initialized"))}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{initializeIOSFallback(),initializeServiceWorkerMessageListener()}):(initializeIOSFallback(),initializeServiceWorkerMessageListener()),"undefined"!=typeof window&&(window.syncUI={isIOSSafari:isIOSSafari,isBackgroundSyncSupported:isBackgroundSyncSupported,showSyncProgress:showSyncProgress,hideSyncProgress:hideSyncProgress,showToast:showToast,triggerManualSync:triggerManualSync,dismissIOSWarning:dismissIOSWarning});