(function(window,document,tsname){var location=window.location;var script=document.currentScript;function cget(name,def){return script&&script.dataset[name]||def}function iget(name,def){return parseInt(cget(name,def),10)}var xhrTimeout=iget("timeout","3000");var historyLimit=iget("history","20");var attrsToSettle=cget("settle","class,style,width,height").split(",");var insertClass=cget("insert-class","ts-insert");var removeClass=cget("remove-class","ts-remove");var activeClass=cget("active-class","ts-active");var READY=false;var Directive;var DIRECTIVES=[];var FUNCS={stop:function(o){if(o.event)o.event.stopPropagation()},prevent:function(o){if(o.event)o.event.preventDefault()},delay:delay,not:function(funcname){var args=[].slice.call(arguments,1,arguments.length-1);var o=merge({},arguments[arguments.length-1]);o.src=o.src.slice(o.command.length+1);o=o;var rv=executeCommand(funcname,args,o);if(rv===null||rv===undefined){return rv}return!rv},target:function(sel,o){try{let el=findTarget(o.el,sel);if(!el)return false;o.el=el;return undefined}catch(e){return false}},remove:arity(o=>{o.el.remove()},(sel,o)=>{findTarget(o.el,sel).remove()}),wait:function(eventname,o){return new Promise(function(resolve){listen(o.el,eventname,resolve,{once:true})})},on:function(eventname,o){var rest=o.line.split(o.src)[1].replace(/^[\s,]+/,"");var action=parseActionSpec(rest)[0];addListener(o.el,eventname,(_el,e)=>{_doAction(action,{el:o.el,event:e})});return false},req:arity((url,o)=>{this.dispatcher(null,url,o)},(method,url,o)=>{doReqBatch(makeReq(o.el,o.event,false,{method:method,url:url,data:o.input?[["input",o.input]]:null}))}),class:function(cls,o){o.el.classList.add(cls)},"class+":function(cls,o){o.el.classList.add(cls)},"class-":function(cls,o){o.el.classList.remove(cls)},"class^":function(cls,o){o.el.classList.toggle(cls)},classtoggle:function(cls,o){o.el.classList.toggle(cls)},text:arity(o=>{if(!(o.input===null||o.input===undefined)){o.el.textContent=o.input}return o.input},(value,o)=>{o.el.textContent=value;return value}),html:arity(o=>{if(!(o.input===null||o.input===undefined)){o.el.innerHTML=o.input}return o.el.innerHTML},(value,o)=>{o.el.innerHTML=value;return value}),attr:arity((name,o)=>{let val=o.el[name];return typeof val!="undefined"?val:getattr(o.el,name)},(name,value,o)=>{o.el[name]=value;setattr(o.el,name,value);return value}),log:function(...args){let o=args[args.length-1];let rest=args.slice(args.length-1);if(o.input){rest.push(o.input)}console.log(...rest)}};var ERR=console.error?console.error.bind(console,"TwinSpark error:"):console.log.bind(console,"TwinSpark error:");function arity(...funcs){let funcmap=funcs.reduce((acc,func)=>{if(acc[func.length]){throw extraerr("Arity dispatch: duplicate function with the same number of arguments",{length:func.length,func:func,duplicate:acc[func.length]})}acc[func.length]=func;return acc},{});return function dispatcher(){var len=arguments.length;var func=funcmap[len];if(!func){throw extraerr("No function supplied accepting "+len+" arguments",{functions:funcmap,arguments:Array.from(arguments)})}return func.apply({dispatcher:dispatcher},arguments)}}var merge=Object.assign||function(tgt,src){if(!src){return tgt}for(var k in src){if(Object.hasOwn(src,k)){tgt[k]=src[k]}}return tgt};function groupBy(arr,keyfn){return arr.reduce(function(acc,v){var key=keyfn(v);(acc[key]||(acc[key]=[])).push(v);return acc},{})}function zip(arr1,arr2){return arr1.map((val,i)=>[val,arr2[i]])}function distinct(arr){var seen=new Set,res=[],val;for(var i=0;i<arr.length;i++){val=arr[i];if(!seen.has(val)){seen.add(val);res.push(val)}}return res}function el2str(el){return el.outerHTML.match(/<.+?>/)[0]}function extraerr(msg,data){var err=Error(msg);err.extra=data;return err}function memoize(orig){var cache=null;return function(){return cache||(cache=orig())}}function parseTime(s){s=s&&s.trim();if(!s)return;if(s.match(/\d+s/))return parseFloat(s)*1e3;return parseFloat(s)}function delay(s){return new Promise(function(resolve){setTimeout(resolve,parseTime(s),true)})}function onload(fn){if(document.readyState=="loading"){document.addEventListener("DOMContentLoaded",fn)}else{fn()}}var onidle=window.requestIdleCallback||function(x){setTimeout(x,100)};function sendEvent(el,type,detail,opts){var bubbles=opts&&"bubbles"in opts?opts.bubbles:true;var event=new CustomEvent(type,{bubbles:bubbles,cancelable:true,detail:detail});console.debug("🛎️ EVENT",type,{el:el,detail:detail});el.dispatchEvent(event);return event}function sendError(el,type,detail){sendEvent(el,type,merge({error:type},detail))}function hasattr(el,attr){return el.hasAttribute(attr)}function getattr(el,attr){return el.getAttribute(attr)}function setattr(el,attr,value){return el.setAttribute(attr,value)}function delattr(el,attr){return el.removeAttribute(attr)}function qsf(el,selector){if(el.nodeType==1&&el.matches(selector))return el;return el.querySelector?el.querySelector(selector):null}function qse(el,selector){if(!el.querySelectorAll)return[];var els=Array.from(el.querySelectorAll(selector));if(el.nodeType==1&&el.matches(selector))els.unshift(el);return els}function elid(el){if(el.id)return el.id;var tag=el.tagName.toLowerCase();if(el.className)return tag+"."+el.className.replace(" ",".");return tag}function elcrumbs(el,attr){var result=[];var value;var _el=el;do{value=getattr(_el,attr);if(value){result.push(value)}}while(_el=_el.parentElement);return result}function internalData(el,attr,def){var k="twinspark-internal";var data=el[k]||(el[k]={});if(!attr)return data;if(!(attr in data)&&typeof def!="undefined")data[attr]=def;return data[attr]}function register(selector,handler){var directive={selector:selector,handler:handler};DIRECTIVES.push(directive);if(READY){qse(document.body,directive.selector).forEach(directive.handler)}}function listen(el,type,func,opts){el.addEventListener(type,func,opts);internalData(el,"event-handlers",[]).push({type:type,func:func,opts:opts});return el}function deactivateEl(el){internalData(el,"event-handlers",[]).forEach(h=>el.removeEventListener(h.type,h.func,h.opts))}function activateEl(el){deactivateEl(el);DIRECTIVES.forEach(d=>el.matches(d.selector)&&d.handler(el))}function activate(el){var selector=DIRECTIVES.map(d=>d.selector).join(",");qse(el,selector).forEach(activateEl);sendEvent(el,"ts-ready")}function autofocus(el){var toFocus=qsf(el,"[autofocus]");if(toFocus){toFocus.focus()}}var ResponseTimeout;var Response;var SwapData;function xhr(url,opts){var xhr=new XMLHttpRequest;return{promise:new Promise(function(resolve,reject){opts||(opts={});xhr.open(opts.method||"GET",url,true);for(var k in opts.headers){xhr.setRequestHeader(k,opts.headers[k])}for(var k in opts.xhr){xhr[k]=opts.xhr[k]}xhr.onreadystatechange=function(){if(xhr.readyState!=4)return;if(xhr.status==0)return;var headers={"ts-title":xhr.getResponseHeader("ts-title"),"ts-history":xhr.getResponseHeader("ts-history"),"ts-swap":xhr.getResponseHeader("ts-swap"),"ts-swap-push":xhr.getResponseHeader("ts-swap-push"),"ts-location":xhr.getResponseHeader("ts-location")};return resolve({ok:xhr.status>=200&&xhr.status<=299,status:xhr.status,url:xhr.responseURL,reqUrl:url,xhr:xhr,opts:opts,headers:headers,content:xhr.responseText})};xhr.timeout=xhrTimeout;xhr.ontimeout=function(){return reject({ok:false,status:0,url:url,content:"timeout"})};xhr.send(opts.body)}),xhr:xhr}}function mergeParams(p1,p2,removeEmpty){if(!p2)return p1;for(var[k,v]of p2){if(!k)continue;if(removeEmpty&&(v===null||v==="")){p1.delete(k)}else{p1.append(k,v)}}return p1}function parseData(v){if(v=="")return null;if(v[0]=="{"){var data=JSON.parse(v);if(typeof data==="object"&&data!==null){var arr=[];for(var k in data){arr.push([k,data[k]])}return arr}}else{return mergeParams(new FormData,new URLSearchParams(v))}}function eldata(el,attr){return elcrumbs(el,attr).reduceRight((acc,v)=>mergeParams(acc,parseData(v),true),new FormData)}function formElementValue(el){if(!el.name)return null;if(el.type=="submit")return null;if((el.type=="radio"||el.type=="checkbox")&&!el.checked){return null}return el.value}function collectData(el,e){var data=eldata(el,"ts-data");var tag=el.tagName;var res;if(tag=="FORM"){let currentElData=new FormData(el);if(e&&e.submitter&&e.submitter.name&&e.submitter.value&&!currentElData.has(e.submitter.name)){data.append(e.submitter.name,e.submitter.value)}data=mergeParams(data,currentElData)}else if(tag=="INPUT"||tag=="SELECT"||tag=="TEXTAREA"){if(res=formElementValue(el))data.append(el.name,res)}return data}var IDB=window.indexedDB;function reqpromise(req){return new Promise(function(resolve,reject){req.onsuccess=function(){resolve(req.result)};req.onerror=function(){reject(req.error)}})}var _idb;function idb(){if(_idb)return _idb;var dbname="twinspark";var req=IDB.open(dbname,1);req.onupgradeneeded=function(){var db=req.result;var store=db.createObjectStore(dbname,{keyPath:"url"});store.createIndex("time","time")};return _idb=reqpromise(req)}function idbStore(db,opts){var rw=opts&&opts.write;return db.transaction(db.name,rw&&"readwrite"||"readonly").objectStore(db.name)}async function deleteOverLimit(db){let store=idbStore(db);let count=await reqpromise(store.count());console.debug("PAGES IN STORAGE",count);var toremove=count-historyLimit;if(toremove<=0)return;store=idbStore(db,{write:true});let req=store.index("time").openCursor();req.onsuccess=function(_){var cursor=req.result;if(cursor){cursor.delete();if(--toremove>0){cursor.continue()}}}}async function storeCurrentState(){if(historyLimit==0)return;var data={url:location.pathname+location.search,html:document.body.innerHTML,time:+new Date};var db=await idb();var store=idbStore(db,{write:true});await reqpromise(store.put(data));await deleteOverLimit(db)}function pushState(url,title){storeCurrentState();history.replaceState("history","","");history.pushState(null,title,url);sendEvent(window,"ts-pushstate",{url:url})}function replaceState(url){history.replaceState("history","",url);sendEvent(window,"ts-replacestate",{url:url})}async function onpopstate(e){if(historyLimit==0)return;if(!e.state)return;let url=location.pathname+location.search;let db=await idb();let store=idbStore(db);let data=await reqpromise(store.get(url));if(data&&data.html){console.debug("onpopstate restore",data.url,data.html.length,data.time);deactivateEl(document);document.body.innerHTML=data.html;if(e.state=="INITIAL"&&!READY){return}activate(document.body)}}function _findSingleTarget(el,sel,childrenOnly){if(!sel||!el){return el}if(sel=="target"){return el}if(sel=="inherit"){var parent=el.parentElement.closest("[ts-target]");return findTarget(parent)}if(sel.slice(0,7)=="parent "){return el.closest(sel.slice(7))}if(sel.slice(0,6)=="child "){return el.querySelector(sel.slice(6))}if(sel.slice(0,8)=="sibling "){return el.parentElement.querySelector(sel.slice(8))}if(childrenOnly){return el.querySelector(sel)}return document.querySelector(sel)}function findSingleTarget(el,sel,childrenOnly){var res=_findSingleTarget(el,sel,childrenOnly);if(res)return res;var elstr=el2str(el);throw extraerr(`Could not find element with selector ${sel} for element ${elstr}`+(childrenOnly?" among children":""),{element:elstr,selector:sel})}function findTarget(el,sel){if(!el)return el;if(sel==null){sel=getattr(el,"ts-target")}if(!sel){return el}var bits=sel.split("|").map(s=>s.trim());return bits.reduce((el,sel,idx)=>findSingleTarget(el,sel,idx>0),el)}function findReply(target,origin,reply){var sel=getattr(origin,"ts-req-selector");if(!sel){if(reply.tagName=="BODY"&&target.tagName!="BODY"){return reply.children[0]}return reply}if(sel.slice(0,9)=="children "){var el=qsf(reply,sel.slice(9));var frag=new DocumentFragment;if(el&&el.children){frag.append.apply(frag,el.children)}return frag}return qsf(reply,sel)}function syncattr(target,source,attr,withProp){if(withProp){let value=source[attr];if(value!=target[attr]){target[attr]=value;value===null||value===false?delattr(target,attr):setattr(target,attr,value)}}else{let value=getattr(source,attr);if(value!=getattr(target,attr)){value===null||value===false?delattr(target,attr):setattr(target,attr,value)}}}function syncSettleAttrs(target,source){for(var attr of attrsToSettle){syncattr(target,source,attr)}}function elementInserted(el){el.classList.add(insertClass);setTimeout(()=>el.classList.remove(insertClass))}function transitionAttrs(el,origin,ctx){if(!el.id)return;var oldEl=origin.querySelector(el.tagName+"[id='"+el.id+"']");if(!oldEl){return elementInserted(el)}var newAttrs=el.cloneNode();syncSettleAttrs(el,oldEl);ctx.tasks.push(function(){syncSettleAttrs(el,newAttrs)});return ctx}var morph=function(){function cleanRemove(el,ctx){ctx.cb("node-remove",el);if(el.nodeType!=1){el.remove();return}el.classList.add(removeClass);var animations=el.getAnimations().filter(a=>a instanceof window.CSSTransition);if(!animations.length){return el.remove()}Promise.all(animations.map(a=>a.finished)).then(()=>{el.remove()})}function cleanInsert(el,ctx){ctx.cb("node-insert",el);if(el instanceof HTMLElement){activate(el);elementInserted(el)}}function syncAttrs(target,reply){if(target.nodeType!=1){target.nodeValue=reply.nodeValue;return}target=target;reply=reply;for(let i=target.attributes.length-1;i>=0;i--){syncattr(target,reply,target.attributes[i].name)}for(var attr of reply.attributes){syncattr(target,reply,attr.name)}if(target.tagName=="INPUT"&&target.type!="file"){syncattr(target,reply,"value",true);syncattr(target,reply,"checked",true);syncattr(target,reply,"disabled",true)}else if(target.tagName=="OPTION"){syncattr(target,reply,"selected",true)}else if(target.tagName=="TEXTAREA"){syncattr(target,reply,"value");if(target.firstChild&&target.firstChild.nodeValue!=reply.value){target.firstChild.nodeValue=reply.value}}}function intersection(setA,setB){const _intersection=new Set;for(const elem of setB){if(setA.has(elem)){_intersection.add(elem)}}return _intersection}function isSimilar(node1,node2){return node1&&node2&&node1.nodeType==node2.nodeType&&node1.tagName==node2.tagName}function findIdsMatch(target,reply){if(reply.nodeType!=1)return null;var el=reply;var replyIds=qse(el,"[id]").map(el=>"#"+CSS.escape(el.id)).join(",");if(!replyIds)return null;el=target;do{if(qsf(el,replyIds)){return el}}while(el=el.nextElementSibling);return null}function findSoftMatch(target,reply,incomingIds){var el=target;var nextReply=reply.nextSibling;var potentialMatches=0;do{var ids=qse(el,"[id]").map(el=>el.id);if(ids.length&&intersection(incomingIds,ids).size){return null}if(!ids.length&&!qse(reply,"[id]").length&&isSimilar(el,reply)){return el}if(isSimilar(el,nextReply)){potentialMatches++;nextReply=nextReply.nextSibling;if(potentialMatches>=2){return null}}}while(el=el.nextSibling);return null}function removeNodesBetween(start,end,ctx){while(start!==end){var todelete=start;start=start.nextSibling;cleanRemove(todelete,ctx)}return end}function morphNode(target,reply,ctx){if(ctx.ignoreActive&&target==document.activeElement&&(target.tagName=="INPUT"||target.tagName=="TEXTAREA")){return target}else if(!reply){cleanRemove(target,ctx);return null}else if(!isSimilar(target,reply)){if(!target.parentElement){target.replaceWith(reply)}else{target.parentElement.insertBefore(reply,target.nextSibling);cleanRemove(target,ctx);cleanInsert(reply,ctx)}return reply}else{syncAttrs(target,reply);if(target.nodeType==1&&reply.nodeType==1){morphChildren(target,reply,ctx)}return target}}function morphChildren(parentTarget,parentReply,ctx){if(parentTarget instanceof HTMLTemplateElement&&parentReply instanceof HTMLTemplateElement){parentTarget=parentTarget.content;parentReply=parentReply.content}var target=parentTarget.firstChild;var nextReply=parentReply.firstChild;var incomingIds=new Set(qse(parentReply,"[id]").map(el=>el.id));while(nextReply){var reply=nextReply;nextReply=reply.nextSibling;if(!target){parentTarget.appendChild(reply);cleanInsert(reply,ctx);continue}var idsMatch=findIdsMatch(target,reply);if(idsMatch){target=removeNodesBetween(target,idsMatch,ctx).nextSibling;morphNode(idsMatch,reply,ctx);continue}var softMatch=findSoftMatch(target,reply,incomingIds);if(softMatch){target=removeNodesBetween(target,softMatch,ctx).nextSibling;morphNode(softMatch,reply,ctx);continue}parentTarget.insertBefore(reply,target);cleanInsert(reply,ctx)}if(target){target=removeNodesBetween(target,parentTarget.lastChild,ctx);cleanRemove(target,ctx)}}var MorphContext;function morph(target,reply,ctx={}){ctx.cb||(ctx.cb=function(){});if(target&&target.nodeType==Node.DOCUMENT_NODE)target=target.documentElement;if(reply&&reply.nodeType==Node.DOCUMENT_NODE)reply=reply.documentElement;return morphNode(target,reply,ctx)}morph.syncAttrs=syncAttrs;return morph}();function executeSwap(strategy,target,reply,ctx){strategy||(strategy="replace");if(strategy!="morph"&&strategy!="morph-all"&&strategy!="skip"){qse(reply,"[id]").forEach(function(el){transitionAttrs(el,target,ctx)})}var ret=reply instanceof DocumentFragment&&Array.from(reply.children);switch(strategy){case"morph-all":reply=morph(target,reply,{ignoreActive:false});break;case"morph":reply=morph(target,reply,{ignoreActive:true});break;case"replace":target.replaceWith(reply);break;case"inner":target.replaceChildren(reply);break;case"prepend":target.prepend(reply);break;case"append":target.append(reply);break;case"beforebegin":target.parentNode.insertBefore(reply,target);break;case"afterend":target.parentNode.insertBefore(reply,target.nextSibling);break;case"skip":break;default:throw Error("Unknown swap strategy "+strategy)}return ret||[reply]}function elementSwap(origin,replyParent,ctx){var target=findTarget(origin);if(!target){throw extraerr(`Target element not found for origin ${el2str(origin)}`,{origin:origin,replyParent:replyParent})}var reply=findReply(target,origin,replyParent);if(!reply){var sel=getattr(origin,"ts-req-selector");throw extraerr(`Cannot find specified html in response, `+`maybe nothing to select as ${sel}`,{sel:sel,replyParent:replyParent,origin:origin})}var strategy=getattr(origin,"ts-swap");if(origin){var detail={response:ctx.response};var e=sendEvent(origin,"ts-req-after",detail);doActions(origin,e,getattr(origin,"ts-req-after"),detail)}return executeSwap(strategy,target,reply,ctx)}function pushedSwap(origin,reply,ctx){var sel=getattr(reply,"ts-swap-push");if(!sel&&reply.id){sel="#"+reply.id}var target=findTarget(findTarget(origin||document.body),sel);if(!target){throw extraerr("cannot find target for server-pushed swap",{reply:reply})}var strategy=getattr(reply,"ts-swap");return executeSwap(strategy,target,reply,ctx)}function headerSwap(header,origin,replyParent,ctx){var m=header.match(/(\w+):(.+)<=(.+)/);if(!m){throw extraerr("Cannot parse ts-swap-push header value",{header:header})}var strategy=m[1];var target=findTarget(findTarget(origin||document.body),m[2]);if(!target)throw extraerr("cannot find target for header swap",{sel:m[2]});var reply=qsf(replyParent,m[3]);if(!reply)throw extraerr("cannot find target for header swap",{reply:reply,sel:m[3]});return executeSwap(strategy,target,reply,ctx)}function runScript(el){var parent=el.parentNode;var newel=document.createElement(el.nodeName);for(var j=0;j<el.attributes.length;j++){var attr=el.attributes[j].name;setattr(newel,attr,getattr(el,attr))}newel.appendChild(document.createTextNode(el.innerHTML));parent.replaceChild(newel,el)}function processScripts(el){var scripts=el.querySelectorAll("script");for(var i=0;i<scripts.length;i++){var script=scripts[i];if((!script.type||script.type=="text/javascript")&&!script.dataset.tsNoload){runScript(script)}}}function swap(origins,replyParent,res){var ctx={response:res,tasks:[]};var swapped=[],viapush,viaheader;var singleOrigin=origins.length==1?origins[0]:null;if(res.headers["ts-swap"]!="skip"){if(singleOrigin){swapped=elementSwap(singleOrigin,replyParent,ctx)}else{swapped=zip(origins,replyParent.children).flatMap(([origin,thisParent])=>{return elementSwap(origin,thisParent,ctx)})}}viapush=qse(replyParent,"[ts-swap-push]").flatMap(reply=>{try{return pushedSwap(singleOrigin,reply,ctx)}catch(e){console.error(e)}});if(res.headers["ts-swap-push"]){viaheader=res.headers["ts-swap-push"].split(",").flatMap(header=>{try{return headerSwap(header,singleOrigin,replyParent,ctx)}catch(e){console.error(e)}})}swapped=swapped.flat();if(viapush)swapped=swapped.concat(viapush.flat());if(viaheader)swapped=swapped.concat(viaheader.flat());swapped=distinct(swapped);swapped.forEach(function(el){processScripts(el);activate(el);autofocus(el)});setTimeout(function(){ctx.tasks.forEach(function(func){func()})},16);return swapped}function swapResponse(url,origins,content,res){var html=(new DOMParser).parseFromString(content,"text/html");html.body.querySelectorAll("noscript").forEach(x=>x.remove());var title=res.headers["ts-title"]||html.title;var replyParent=html.body;if(replyParent.children.length<origins.length&&res.headers["ts-swap"]!="skip"){throw`This request needs at least ${origins.length} elements, `+`but ${replyParent.children.length} were returned`}var pushurl=res.headers["ts-history"]||hasattr(origins[0],"ts-req-history")&&url;if(pushurl){if(getattr(origins[0],"ts-req-history")=="replace"){replaceState(pushurl)}else{pushState(pushurl,title)}}return swap(origins,replyParent,res)}function redirectResponse(targetUrl,res){location.href=targetUrl;return res}function mergeHeaders(h1,h2){for(var k in h2){if(!h1[k]){h1[k]=h2[k]}else if(h1[k]!=h2[k]){h1[k]+=", "+h2[k]}}return h1}function makeOpts(req){var data=collectData(req.el,req.event?.detail?.event??req.event);return{method:req.method,data:mergeParams(data,req.opts.data),xhr:{},headers:{Accept:"text/html+partial","TS-URL":location.pathname+location.search,"TS-Origin":elid(req.el),"TS-Target":elid(findTarget(req.el))}}}function setReqBody(opts,body){if(!body){return opts}if(typeof body==="string"||!Array.from(body.entries()).every(x=>typeof x[1]==="string")){opts.body=body;return opts}var simplebody=new URLSearchParams(body);opts.body=simplebody.toString();opts.headers["Content-Type"]="application/x-www-form-urlencoded";return opts}function _doReqBatch(batch){if(!batch.length)return;var url=batch[0].url;var method=batch[0].method;var data;let json=getattr(batch[0].el,"ts-json");if(json){if(batch.length>1){throw extraerr("Cannot batch json requests",{batch:batch})}data=json;batch[0].opts.headers["Content-Type"]="application/json"}else{data=batch.reduce(function(acc,req){return mergeParams(acc,req.opts.data)},new FormData)}var qs=method=="GET"?new URLSearchParams(data).toString():null;var body=method!="GET"?data:null;var opts={method:method,xhr:batch.reduce(function(x,req){return req.opts.xhr},{}),headers:batch.reduce(function(h,req){return mergeHeaders(h,req.opts.headers)},{})};opts=setReqBody(opts,body);var fullurl=url;if(qs){fullurl+=url.indexOf("?")==-1?"?":"&";fullurl+=qs}var origins=batch.map(function(req){return req.el});var executed=xhr(fullurl,opts);origins.forEach(function(el){el.setAttribute("aria-busy","true");el.classList.add(activeClass);internalData(el)["active-xhr"]=executed.xhr});return executed.promise.then(function(res){onidle(()=>origins.forEach(el=>{el.removeAttribute("aria-busy");el.classList.remove("ts-active");delete internalData(el)["active-xhr"]}));if(executed.xhr.status==0&&executed.xhr.statusText=="abort"){return false}if(res.ok){res=res;if(res.headers["ts-location"]){return redirectResponse(res.headers["ts-location"],res)}let redirected=res.url&&res.url!=new URL(fullurl,location.href).href;if(redirected){if(!res.headers["ts-history"]){res.headers["ts-history"]=res.url}res.swap=swapResponse(res.url,[document.body],res.content,res)}else{res.swap=swapResponse(url,origins,res.content,res)}return res}ERR("Something wrong with response",res.content);origins.forEach(function(el){sendError(el,"ts-req-error",{response:res,url:fullurl,opts:opts})});return res}).catch(function(res){onidle(()=>origins.forEach(el=>{el.removeAttribute("aria-busy");el.classList.remove("ts-active");delete internalData(el)["active-xhr"]}));ERR("Error retrieving backend response",fullurl,res.error||res);origins.forEach(function(el){sendError(el,"ts-req-error",{response:res,url:fullurl,opts:opts})});return res})}function doReqBatch(reqs){reqs=Array.isArray(reqs)?reqs:[reqs];return Promise.all(reqs.map(function(req){req.opts=makeOpts(req);var detail={req:req,originalTarget:req.event.detail&&req.event.detail.originalTarget||req.event.target};var e=sendEvent(req.el,"ts-req-before",detail);if(e.defaultPrevented)return null;var result=req;var action=doActions(req.el,e,getattr(req.el,"ts-req-before"),detail);if(action){result=action.then(function(res){return e.defaultPrevented?null:req})}var strategy=getattr(req.el,"ts-req-strategy")||"queue";var activeXHR=internalData(req.el)["active-xhr"];if(strategy==="first"&&activeXHR){return null}if(strategy==="last"&&activeXHR){activeXHR.abort();delete internalData(req.el)["active-xhr"]}return result})).then(function(res){return res.filter(function(req){return!!req})}).then(_doReqBatch)}var Req;var queue={reqs:[],request:null};function executeRequests(){var batches=groupBy(queue.reqs,req=>req.method+req.url);queue={reqs:[],request:null};for(var k in batches){doReqBatch(batches[k])}}function queueRequest(req){queue.reqs.push(req);if(!queue.request){queue.request=setTimeout(executeRequests,16)}}function makeReq(el,e,batch,opts){var url=opts?.url||(batch?getattr(el,"ts-req-batch"):getattr(el,"ts-req"))||(el.tagName=="FORM"?getattr(el,"action"):getattr(el,"href"));var method=(opts?.method||getattr(el,"ts-req-method")||(el.tagName=="FORM"?getattr(el,"method")||"POST":"GET")).toUpperCase();return{el:el,opts:{data:opts?.data},event:e,url:url,method:method,batch:batch}}function onNative(el,func){var tag=el.tagName;var event="click";if(tag=="FORM")event="submit";else if(tag=="INPUT"||tag=="SELECT"||tag=="TEXTAREA")event="change";var lastbutton=null;if(tag=="FORM"&&event=="submit"){qse(el,'button, input[type="submit"]').forEach(btn=>{listen(btn,"click",e=>{lastbutton=e.target})})}return listen(el,event,function(e){if(e.altKey||e.ctrlKey||e.shiftKey||e.metaKey||(e.button||0)!=0)return;e.preventDefault();e.stopPropagation();if(!e.submitter&&lastbutton&&lastbutton.type=="submit"){e.submitter=lastbutton}func(e);lastbutton=null})}register("[ts-req]",function(el){function handler(e){doReqBatch([makeReq(el,e,false)])}if(hasattr(el,"ts-trigger")){listen(el,"ts-trigger",handler)}else{onNative(el,handler)}});register("[ts-req-batch]",function(el){function handler(e){queueRequest(makeReq(el,e,true))}if(hasattr(el,"ts-trigger")){listen(el,"ts-trigger",handler)}else{onNative(el,handler)}});var CommandDef;var ActionDef;var CommandPayload;function registerCommands(cmdsOrName,maybeFunc){if(typeof cmdsOrName=="object"){return merge(FUNCS,cmdsOrName)}else if(maybeFunc){FUNCS[cmdsOrName]=maybeFunc}return FUNCS}function executeCommand(command,args,payload){var cmd=window._ts_func&&window._ts_func[command]||FUNCS[command]||window[command];if(!cmd){throw Error("Unknown action command: "+payload.src)}return cmd.apply(payload.el,args.concat([payload]))}function parseActionSpec(s){var actions=[];var action=[];var command=[];var current="";var command_start=0,action_start=0,i=0;var quote=null;function parseValue(s){var c=s[0];if(c=='"'||c=="'"){return s.slice(1,s.length-1)}return s}function consume(){var token=current.trim();if(token.length){command.push(parseValue(token))}current=""}function consumeCommand(){if(!command.length)return;action.push({src:s.slice(command_start,i).trim(),name:command[0],args:command.slice(1)});command=[];command_start=i+1}function consumeAction(){if(!action.length)return;actions.push({src:s.slice(action_start,i).trim(),commands:action});action=[];action_start=i+1}for(i=0;i<s.length;i++){var c=s[i];if(quote){if(c=="\\"){i++;current+=s[i]}else if(c==quote){current+=c;quote=null}else{current+=c}}else{if(c=="'"||c=='"'){quote=c}else if(c==" "){consume();continue}else if(c==","){consume();consumeCommand();continue}else if(c==";"){consume();consumeCommand();consumeAction();continue}current+=c}}consume();consumeCommand();consumeAction();return actions}async function _doAction(action,payload){console.debug("ACTION",action.src,payload);var opts=merge({line:action.src},payload);var rv=null;for(var command of action.commands){console.debug(rv!==false?"🔵":"🚫","COMMAND",command.src,{prev:rv,src:action.src,el:opts.el});if(rv===false)return rv;if(rv!==undefined)opts.input=rv;opts.command=command.name;opts.src=command.src;opts=opts;try{rv=await executeCommand(command.name,command.args,opts)}catch(e){throw merge(e,{extra:{command:command.src,action:action.src,element:el2str(opts.el)}})}}return rv}function doActions(target,e,spec,payload){if(!spec)return;console.debug("ACTIONS",{spec:spec,event:e,payload:payload});var actions=parseActionSpec(spec);var mypayload=merge({el:target,event:e},payload);var result;for(var i=0;i<actions.length;i++){var action=actions[i];if(action.commands.length){result=_doAction(action,mypayload)}}return result}register("[ts-action]",function(el){var handler=function(e){if(e.detail&&e.detail.event){e=e.detail.event}doActions(findTarget(el),e,getattr(el,"ts-action"),null)};if(hasattr(el,"ts-trigger")){listen(el,"ts-trigger",handler)}else if(el.tagName=="A"||el.tagName=="BUTTON"){onNative(el,handler)}else{ERR("No trigger for action on element",el)}});function makeObserver(opts){var on=opts.on;var off=opts.off;var threshold=opts.threshold;return new IntersectionObserver(function(entries,obs){for(var i=0;i<entries.length;i++){var entry=entries[i];if(entry.intersectionRatio>threshold){sendEvent(entry.target,on,{entry:entry})}else if(entry.intersectionRatio<threshold){sendEvent(entry.target,off,{entry:entry})}}},opts)}var visibleObs=memoize(function(){return makeObserver({on:"visible",off:"invisible",rootMargin:"0px",threshold:.01})});var closebyObs=memoize(function(){var margin=(window.innerHeight/2|0)+"px";return makeObserver({on:"closeby",off:"away",rootMargin:margin,threshold:.01})});var removedObs=memoize(function(){return new MutationObserver(function(recs){for(var i=0;i<recs.length;i++){var rec=recs[i];for(var j=0;j<rec.removedNodes.length;j++){var node=rec.removedNodes[j];sendEvent(node,"remove",{record:rec})}}})});var childrenObs=memoize(function(){return new MutationObserver(function(recs){for(var i=0;i<recs.length;i++){var rec=recs[i];if(rec.type=="childList"){var emptyEvent=rec.target.childNodes.count?"notempty":"empty";sendEvent(rec.target,emptyEvent,{record:rec});sendEvent(rec.target,"childrenChange",{record:rec})}}})});function makeTriggerListener(t){var delay=t.args.indexOf("delay");var spec={changed:t.args.indexOf("changed")!=-1,once:t.args.indexOf("once")!=-1,delay:delay!=-1?parseTime(t.args[delay+1]):null};return function(el,e){var data=internalData(el,"trigger",{});function executeTrigger(){sendEvent(el,"ts-trigger",{event:e,originalTarget:e.target},{bubbles:false})}if(spec.once){if(data.once){return}data.once=true}if(spec.changed){if(data.value==formElementValue(el)){return}data.value=formElementValue(el)}if(spec.delay){if(data.delay){clearTimeout(data.delay)}data.delay=setTimeout(executeTrigger,spec.delay)}else{executeTrigger()}}}function addRemovableListener(el,type,handler,opts){function inner(e){handler(e);var data=internalData(el,"trigger",{});if(data.once){el.removeEventListener(type,inner,opts)}}listen(el,type,inner,opts)}function addListener(el,type,handler){switch(type){case"load":onidle(function(){handler(el,{type:"load"})});break;case"windowScroll":addRemovableListener(window,"scroll",function(e){handler(el,e)},{passive:true});break;case"scroll":addRemovableListener(el,"scroll",function(e){handler(el,e)},{passive:true});break;case"outside":addRemovableListener(document,"click",function(e){if(!el.contains(e.target)){handler(el,e)}},{capture:true});break;case"remove":removedObs().observe(el.parentElement,{childList:true});listen(el,type,function(e){handler(el,e)});break;case"empty":case"notempty":case"childrenChange":childrenObs().observe(el,{childList:true});listen(el,type,function(e){handler(el,e)});break;case"visible":case"invisible":visibleObs().observe(el);listen(el,type,function(e){handler(el,e)});break;case"closeby":case"away":closebyObs().observe(el);listen(el,type,function(e){handler(el,e)});break;default:addRemovableListener(el,type,function(e){handler(el,e)})}}function registerTrigger(el,t){var type=t.name;var tsTrigger=makeTriggerListener(t);addListener(el,type,tsTrigger)}register("[ts-trigger]",function(el){var spec=getattr(el,"ts-trigger");if(!spec)return;var triggers=parseActionSpec(spec)[0];triggers.commands.forEach(function(t){registerTrigger(el,t)})});function init(_e){window.addEventListener("popstate",onpopstate);window.addEventListener("beforeunload",storeCurrentState);activate(document.body);READY=true;console.debug("init done",_e)}onload(init);if(window.performance?.navigation?.type==window.performance.navigation.TYPE_BACK_FORWARD){onpopstate({state:"INITIAL"})}var twinspark={onload:onload,register:register,activate:activate,func:registerCommands,elcrumbs:elcrumbs,arity:arity,data:collectData,merge:mergeParams,target:findTarget,query:findTarget,trigger:sendEvent,parseAction:parseActionSpec,action:doActions,exec:executeCommand,makeReq:makeReq,executeReqs:doReqBatch,morph:morph,setERR:errhandler=>ERR=errhandler,_internal:{DIRECTIVES:DIRECTIVES,FUNCS:FUNCS,init:init}};window[tsname]=twinspark})(window,document,"twinspark");